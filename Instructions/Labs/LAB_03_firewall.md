---
lab:
  title: 练习 03 - 创建和配置 Azure 防火墙
  module: Guided Project - Configure secure access to workloads with Azure virtual networking services
---

# 练习 03 - 创建和配置 Azure 防火墙

## 场景

贵组织需要为应用虚拟网络提供集中式网络安全。 随着应用程序使用量的增加，需要更精细的应用程序级筛选和高级威胁防护。 此外，预计应用程序将需要从 Azure DevOps 管道进行持续更新。 你确定这些要求。
+ 需要使用 Azure防火墙才能在 app-vnet 中实现其他安全性。 
+ 应配置**防火墙策略**，以帮助管理对应用程序的访问。 
+ 需要防火墙策略**应用程序规则**。 此规则允许应用程序访问 Azure DevOps，以便可以更新应用程序代码。 
+ 需要防火墙策略**网络规则**。 此规则将允许 DNS 解析。 

### 技能任务

+ 创建 Azure 防火墙。
+ 创建和配置防火墙策略
+ 创建应用程序规则集合。
+ 创建网络规则集合。

## 体系结构关系图

![显示包含防火墙和路由表的一个虚拟网络的示意图。](../Media/task-3.png)


  
## 练习说明

### 在我们的现有虚拟网络中创建 Azure 防火墙子网

1. 在门户顶部的搜索框中，输入“虚拟网络”。 在搜索结果中，选择“虚拟网络”。

1. 选择“app-vnet”****。

1. 选择“子网”。

1. 选择“**+ 子网**”。

1. 输入以下信息并选择**保存**。

    | 属性      | 值                   |
    | :------------ | :---------------------- |
    | 名称          | **AzureFirewallSubnet** |
    | 地址范围 | 10.1.63.0/24****        |

**** 备注：将所有其他设置保留为默认值。

### 创建 Azure 防火墙

1. 在门户顶部的搜索框中，输入“防火墙”。 在搜索结果中选择“防火墙”。

1. 选择“+ 新建”。

1. 使用下表中的值创建防火墙。 对于未指定的任何属性，请使用默认值。
    >备注****：部署 Azure 防火墙可能需要几分钟时间。

    | 属性                 | 值                                             |
    | :----------------------- | :------------------------------------------------ |
    | 资源组           | RG1****                                           |
    | 名称                     | app-vnet-firewall****                             |
    | 防火墙 SKU             | **标准**                                      |
    | 防火墙管理      | **使用防火墙策略来管理此防火墙** |
    | 防火墙策略          | 选择“新增”****                                |
    | 策略名称              | fw-policy****                                     |
    | 区域                   | **美国东部**                                       |
    | 策略层              | **标准**                                      |
    | 选择虚拟网络 | **使用现有项**                                  |
    | 虚拟网络          | app-vnet**** (RG1)                                |
    | 公共 IP 地址        | 新添：fwpip****                                |

    了解更多有关如何创建防火墙的信息[](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal)。

1. 选择“查看 + 创建”，然后选择“创建”。

### 更新该防火墙策略

1. 在门户中，搜索并选择 `Firewall Policies`。 

1. 选择 fw-policy****。

### 添加应用程序规则

1. 在“**设置**”边栏选项卡中，选择“**应用规则**”，然后选择“**添加规则集合**”。

1. 配置应用程序规则集合，然后选择“**添加**”。 

    | 属性               | 值                                     |
    | :--------------------- | :---------------------------------------- |
    | 名称                   | `app-vnet-fw-rule-collection`         |
    | 规则集合类型   | **应用程序**                           |
    | 优先级               | `200`                                   |
    | 规则集合操作 | **允许**                                 |
    | 规则集合组  | DefaultApplicationRuleCollectionGroup |
    | 名称             | `AllowAzurePipelines`                |
    | 源类型      | IP 地址                         |
    | 源           | `10.1.0.0/23`                       |
    | 协议         | `https`                             |
    | 目标类型 | **FQDN**                                  |
    | 目标      | `dev.azure.com, azure.microsoft.com` |

备注****：AllowAzurePipelines**** 规则允许 Web 应用程序访问 Azure Pipelines。 该规则允许 Web 应用程序访问 Azure DevOps 服务和 Azure 网站。

### 添加网络规则

1. 在“**设置**”边栏选项卡中，选择“**网络规则**”，然后选择“**添加网络集合**”。

1. 配置网络规则，然后选择“**添加**”。  

    | 属性               | 值                                 |
    | :--------------------- | :------------------------------------ |
    | 名称                   | `app-vnet-fw-nrc-dns`               |
    | 规则集合类型   | **Network**                           |
    | 优先级               | `200`                        |
    | 规则集合操作 | **允许**                             |
    | 规则集合组  | DefaultNetworkRuleCollectionGroup |
    | 规则                  | AllowDns****         |
    | Source                | `10.1.0.0/23`      |
    | 协议              | **UDP**              |
    | 目标端口     | `53`               |
    | 目标地址 | 1.1.1.1, 1.0.0.1**** |

### 验证防火墙和防火墙策略状态

1. 在门户中搜索并选择“**防火墙**”。 

1. 查看 **app-vnet-firewall** 并确保**预配状态****成功**。 这可能需要几分钟的时间。 

1. 在门户中搜索并选择“**防火墙策略**”。

1. 查看 **fw-policy**并确保**预配状态****成功**。 这可能需要几分钟的时间。

### 通过在线培训了解更多信息

+ [Azure 防火墙简介](https://learn.microsoft.com/training/modules/introduction-azure-firewall/)。 在本模块中，你将了解 Azure 防火墙的功能、规则、部署选项和管理。
+ [Azure 防火墙管理器简介](https://learn.microsoft.com/training/modules/intro-to-azure-firewall-manager/)。 在本模块中，你将了解 Azure 防火墙管理器如何为基于云的安全外围提供集中安全策略和路由管理。

### 关键结论

祝贺你完成本练习。 以下是要点：

+ Azure 防火墙是基于云的安全服务，可保护 Azure 虚拟网络资源免受传入和传出威胁的影响。
+ Azure 防火墙策略是一种资源，其中包含 NAT、网络和应用程序规则的一个或多个集合。
+ 网络规则允许或拒绝基于 IP 地址、端口和协议的流量。
+ 应用程序规则允许或拒绝基于完全限定的域名 (FQDN)、URL 和 HTTP/HTTPS 协议的流量。
